package execution

import (
	"brian-nunez/bcode/views/pages"
	"brian-nunez/bcode/views/components/input"
	"brian-nunez/bcode/views/components/button"
	"brian-nunez/bcode/views/components/card"
)

templ Execution() {
	@pages.Layout() {
		<body class="bg-gray-50">
			<div class="max-w-4xl mx-auto py-12 px-4">
				@card.Card(card.Props{Class: "p-6"}) {
					<h1 class="text-2xl font-bold mb-6">Disposable Browser Execution</h1>
					
					<form onsubmit="runJob(event)" class="space-y-4">
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-1">Target URL</label>
							@input.Input(input.Props{
								ID:          "url",
								Name:        "url",
								Placeholder: "https://example.com",
								Required:    true,
								Type:        input.TypeURL,
							})
						</div>
						
						<div>
							<label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
							<select id="action-select" name="action" class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring" onchange="toggleInstruction()">
								<option value="scrape">Scrape Content</option>
								<option value="describe">Describe Page (Ollama)</option>
								<option value="ai_action">AI Action (Ollama)</option>
							</select>
						</div>

						<div id="instruction-container" class="hidden">
							<label class="block text-sm font-medium text-gray-700 mb-1">Instruction / Prompt (Optional)</label>
							<textarea id="instruction" name="instruction" class="flex min-h-[80px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50" placeholder="e.g. 'Summarize the main article' or 'Find the price'"></textarea>
						</div>

						@button.Button(button.Props{
							Type: "submit",
							Class: "w-full",
						}) {
							Run Job
						}
					</form>

					<div class="mt-8">
						<h2 class="text-lg font-semibold mb-2">Live View</h2>
						<div class="mb-4 p-2 bg-gray-100 rounded border border-gray-200 min-h-[200px] flex items-center justify-center">
							<img id="live-monitor" src="https://placehold.co/600x400?text=Waiting+for+Stream..." class="max-w-full h-auto rounded shadow-sm transition-all duration-200" />
						</div>

						<h2 class="text-lg font-semibold mb-2">Execution Logs</h2>
						<div id="logs" class="bg-black text-green-400 p-4 rounded-md font-mono text-sm h-96 overflow-y-auto whitespace-pre-wrap">
							<!-- Logs will appear here -->
						</div>
						
						<!-- Container for final result -->
						<div id="final-result"></div>
					</div>
				@card.Content() {}
				}
			</div>
			<script>
				function toggleInstruction() {
					var action = document.getElementById('action-select').value;
					var container = document.getElementById('instruction-container');
					if (action === 'describe' || action === 'ai_action') {
						container.classList.remove('hidden');
					} else {
						container.classList.add('hidden');
					}
				}

				async function runJob(e) {
					e.preventDefault();
					const logsDiv = document.getElementById('logs');
					const liveMonitor = document.getElementById('live-monitor');
					const finalResult = document.getElementById('final-result');
					
					logsDiv.innerHTML = '';
					finalResult.innerHTML = '';
					liveMonitor.src = "https://placehold.co/600x400?text=Connecting...";

					const formData = new FormData();
					formData.append('url', document.getElementById('url').value);
					formData.append('action', document.getElementById('action-select').value);
					formData.append('instruction', document.getElementById('instruction').value);

					try {
						const response = await fetch('/execute', {
							method: 'POST',
							body: formData
						});

						const reader = response.body.getReader();
						const decoder = new TextDecoder();
						let buffer = '';

						while (true) {
							const { done, value } = await reader.read();
							if (done) break;
							
							// Append new chunk
							buffer += decoder.decode(value, { stream: true });
							
							// Process complete lines
							let newlineIndex;
							while ((newlineIndex = buffer.indexOf('\n')) !== -1) {
								const line = buffer.slice(0, newlineIndex);
								buffer = buffer.slice(newlineIndex + 1);
								
								if (!line.trim()) continue;

								if (line.startsWith('LOG: ')) {
									const content = line.substring(5);
									logsDiv.insertAdjacentHTML('beforeend', content);
									logsDiv.scrollTop = logsDiv.scrollHeight;
								} else if (line.startsWith('IMG: ')) {
									const base64 = line.substring(5);
									liveMonitor.src = 'data:image/jpeg;base64,' + base64;
								} else if (line.startsWith('END: ')) {
									const content = line.substring(5);
									finalResult.innerHTML = content;
								}
							}
						}
					} catch (err) {
						logsDiv.innerHTML += `<div class="text-red-500">Error: ${err.message}</div>`;
					}
				}
			</script>
		</body>
	}
}

templ JobResultView(data string, image string) {
	<div class="mt-4 p-4 bg-gray-900 rounded-md border border-gray-700">
		if image != "" {
			<div class="mb-4">
				<h3 class="text-white font-bold mb-2">Screenshot</h3>
				<img src={ "data:image/jpeg;base64," + image } class="max-w-full h-auto rounded border border-gray-600"/>
			</div>
		}
		<div>
			<h3 class="text-white font-bold mb-2">Result Data</h3>
			<div class="p-2 bg-gray-800 rounded text-white overflow-x-auto">
				{ data }
			</div>
		</div>
	</div>
}
